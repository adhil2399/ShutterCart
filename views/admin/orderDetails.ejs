 <%- include('../partials/admin/header') %>

<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Order Details</h2>
        </div>
    </div>
    <div class="card">
        <header class="card-header">
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-6 mb-lg-0 mb-15">
                    <span id="orderDate">
                        <i class="material-icons md-calendar_today"></i> <b><%= new Date(order.createdAt).toLocaleString() %></b>
                    </span> <br>
                    <small class="text-muted">Order ID: <%= order.orderId %></small>
                    <% if (order.razorpayOrderId) { %>
                        <br>
                        <small class="text-muted">Razorpay Order ID: <%= order.razorpayOrderId %></small>
                    <% } %>
                </div>
                <div class="col-lg-6 col-md-6 ms-auto text-md-end" data-order-id="<%= order.orderId %>">
                    <select id="statusSelect" class="form-select d-inline-block mb-lg-0 mb-15 mw-200">
                        <option>Change status</option>
                        <option value="Pending Payment" <%= order.status === 'Pending Payment' ? 'selected' : '' %>>Pending Payment</option>
                        <option value="Placed" <%= order.status === 'Placed' ? 'selected' : '' %>>Placed</option>
                        <option value="Rejected" <%= order.status === 'Rejected' ? 'selected' : '' %>>Rejected</option>
                        <option value="Delivered" <%= order.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                        <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                        <option value="Return Request" <%= order.status === 'Return Request' ? 'selected' : '' %>>Return Request</option>
                        <option value="Returned" <%= order.status === 'Returned' ? 'selected' : '' %>>Returned</option>
                    </select>
                    <a id="saveButton" class="btn btn-primary" href="#">Save</a>
                    <!-- <a class="btn btn-secondary print ms-2" href="#"><i class="icon material-icons md-print"></i></a> -->
                </div>
            </div>
        </header>
        <div class="card-body">
            <div class="row mb-50 mt-20 order-info-wrap">
                <div class="col-md-4">
                    <article class="icontext align-items-start">
                        <span class="icon icon-sm rounded-circle bg-primary-light">
                            <i class="text-primary material-icons md-person"></i>
                        </span>
                        <div class="text">
                            <h6 class="mb-1">Customer Details</h6>
                            <p class="mb-1">
                                <%= order.userId.name %> <br>
                                <%= order.userId.email %><br>
                                <%= order.userId.phone %>
                            </p>
                        </div>
                    </article>
                </div>
                <div class="col-md-4">
                    <article class="icontext align-items-start">
                        <span class="icon icon-sm rounded-circle bg-primary-light">
                            <i class="text-primary material-icons md-local_shipping"></i>
                        </span>
                        <div class="text">
                            <h6 class="mb-1">Shipping Address</h6>
                            <p class="mb-1">
                                <%= order.address.name %><br>
                                <%= order.address.addressType %><br>
                                <%= order.address.landMark %><br>
                                <%= order.address.city %>, <%= order.address.state %><br>
                                PIN: <%= order.address.pinCode %><br>
                                Phone: <%= order.address.phone %>
                                <% if (order.address.altPhone) { %>
                                    <br>Alt Phone: <%= order.address.altPhone %>
                                <% } %>
                            </p>
                        </div>
                    </article>
                </div>
                <div class="col-md-4">
                    <article class="icontext align-items-start">
                        <span class="icon icon-sm rounded-circle bg-primary-light">
                            <i class="text-primary material-icons md-payment"></i>
                        </span>
                        <div class="text">
                            <h6 class="mb-1">Payment Info</h6>
                            <p class="mb-1">
                                Method: <%= order.paymentMethod %><br>
                                Status: <span class="badge <%= 
                                    order.paymentStatus === 'Paid' ? 'bg-success' : 
                                    order.paymentStatus === 'Unpaid' ? 'bg-warning' : 
                                    order.paymentStatus === 'Refunded' ? 'bg-info' : 
                                    'bg-danger' %>">
                                    <%= order.paymentStatus %>
                                </span><br>
                                Order Status: <span class="badge <%= 
                                    order.status === 'Delivered' ? 'bg-success' : 
                                    order.status === 'Cancelled' ? 'bg-danger' : 
                                    order.status === 'Return Request' ? 'bg-warning' : 
                                    'bg-primary' %>">
                                    <%= order.status %>
                                </span>
                            </p>
                        </div>
                    </article>
                </div>
            </div>

            <% if (order.returnRequest && order.returnRequest.status !== null) { %>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title">Return Request Information</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Status:</strong> 
                                            <span class="badge <%= 
                                                order.returnRequest.status === 'Pending' ? 'bg-warning' : 
                                                order.returnRequest.status === 'Approved' ? 'bg-success' : 
                                                'bg-danger' %>">
                                                <%= order.returnRequest.status %>
                                            </span>
                                        </p>
                                        <p><strong>Reason:</strong> <%= order.returnRequest.reason %></p>
                                        <p><strong>Details:</strong> <%= order.returnRequest.details || 'No additional details provided' %></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Request Date:</strong> <%= new Date(order.returnRequest.date).toLocaleString() %></p>
                                        <% if (order.returnRequest.processedDate) { %>
                                            <p><strong>Processed Date:</strong> <%= new Date(order.returnRequest.processedDate).toLocaleString() %></p>
                                        <% } %>
                                        <% if (order.returnRequest.status === 'Pending') { %>
                                            <div class="mt-3">
                                                <button class="btn btn-success btn-sm process-return" 
                                                        data-order-id="<%= order.orderId %>" 
                                                        data-action="approve">
                                                    <i class="fas fa-check"></i> Approve Return
                                                </button>
                                                <button class="btn btn-danger btn-sm ms-2 process-return" 
                                                        data-order-id="<%= order.orderId %>" 
                                                        data-action="reject">
                                                    <i class="fas fa-times"></i> Reject Return
                                                </button>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>

            <div class="row">
                <div class="col-lg-12">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th width="15%">Image</th>
                                    <th width="25%">Product Name</th>
                                    <th width="15%">Category</th>
                                    <th width="15%">Unit Price</th>
                                    <th width="15%">Quantity</th>
                                    <th width="15%" class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% order.orderedItems.forEach(item => { %>
                                    <tr>
                                        <td>
                                            <div class="left">
                                                <img src="<%= item.product.productImage[0] %>" width="40" height="40" class="img-xs" alt="<%= item.product.name %>">
                                            </div>
                                        </td>
                                        <td>
                                                  <br>
                                                <small class="text-muted"><%= item.product.productName %></small>
                                        </td>
                                        <td>
                                            <%= item.product.category ? item.product.category.name : 'N/A' %>
                                        </td>
                                        <td>₹<%= item.product.salePrice.toFixed(2) %></td>
                                        <td><%= item.quantity %></td>
                                        <td class="text-end">₹<%= (item.product.salePrice * item.quantity).toFixed(2) %></td>
                                    </tr>
                                <% }) %>
                                <tr>
                                    <td colspan="6">
                                        <article class="float-end">
                                            <dl class="dlist">
                                                <dt>Total MRP:</dt>
                                                <dd>₹<%= order.totalPrice.toFixed(2) %></dd>
                                            </dl>
                                            <% if (order.discount.bestOffer > 0) { %>
                                                <dl class="dlist">
                                                    <dt>Best Offer Discount:</dt>
                                                    <dd>-₹<%= order.discount.bestOffer.toFixed(2) %></dd>
                                                </dl>
                                            <% } %>
                                            <% if (order.couponApplied && order.discount.coupon > 0) { %>
                                                <dl class="dlist">
                                                    <dt>Coupon Discount:</dt>
                                                    <dd>-₹<%= order.discount.coupon.toFixed(2) %></dd>
                                                </dl>
                                            <% } %>
                                            <dl class="dlist">
                                                <dt>Total Discount:</dt>
                                                <dd>-₹<%= order.discount.total.toFixed(2) %></dd>
                                            </dl>
                                            <dl class="dlist">
                                                <dt>Final Amount:</dt>
                                                <dd><b class="h5">₹<%= order.finalAmount.toFixed(2) %></b></dd>
                                            </dl>
                                        </article>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<%- include('../partials/admin/footer') %>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const orderDateElement = document.getElementById('orderDate').querySelector('b');
        const orderDate = new Date(orderDateElement.textContent);
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };
        orderDateElement.textContent = orderDate.toLocaleDateString('en-US', options);
    });
</script>

<script>
    document.getElementById('saveButton').addEventListener('click', function(event) {
        event.preventDefault();
        const status = document.getElementById('statusSelect').value;
        const orderId = document.querySelector('.col-lg-6.col-md-6.ms-auto.text-md-end').getAttribute('data-order-id');
        console.log(orderId);
         if (status !== 'Change status') {
            fetch('/admin/update-order-status', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ status: status, orderId })
})
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // SweetAlert for success
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Status updated successfully',
            });
        } else {
            // SweetAlert for failure
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Failed to update status. Please try again.',
                confirmButtonText: 'Retry'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // SweetAlert for unexpected errors
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An unexpected error occurred. Please check the console for more details.',
            confirmButtonText: 'OK'
        });
    });
} else {
    // SweetAlert for invalid status selection
    Swal.fire({
        icon: 'warning',
        title: 'Invalid Selection',
        text: 'Please select a valid status before saving.',
        confirmButtonText: 'OK'
    });
}

    });
    document.querySelectorAll('.process-return').forEach((button) => {
  button.addEventListener('click', async (event) => {
    const orderId = event.target.getAttribute('data-order-id');
    const action = event.target.getAttribute('data-action'); // 'approve' or 'reject'

    // Confirmation dialog
    const confirmation = await Swal.fire({
      title: `Are you sure?`,
      text: `You are about to ${action} this return request.`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: `Yes, ${action} it!`,
      cancelButtonText: 'Cancel',
    });

    if (confirmation.isConfirmed) {
      try {
        const response = await fetch(`/admin/order/return/${orderId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ action }),
        });

        const data = await response.json();

        if (response.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: `Return request ${action}ed successfully.`,
          }).then(() => {
            window.location.reload(); // Reload the page to reflect changes
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.message || `Failed to ${action} return request.`,
          });
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message || 'An unexpected error occurred.',
        });
      }
    }
  });
});

</script>